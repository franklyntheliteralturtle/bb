# Super Browser - Railway Deployment
# Using FULL python image (not slim) for better library support
FROM python:3.11

WORKDIR /app

# Install comprehensive graphics/X11 libraries
# This is intentionally verbose to ensure we get everything OpenCV might need
RUN apt-get update && apt-get install -y \
    # Core X11
    libx11-6 \
    libx11-xcb1 \
    # XCB and all its modules
    libxcb1 \
    libxcb-shm0 \
    libxcb-xfixes0 \
    libxcb-shape0 \
    libxcb-render0 \
    libxcb-render-util0 \
    libxcb-randr0 \
    libxcb-xinerama0 \
    libxcb-icccm4 \
    libxcb-image0 \
    libxcb-keysyms1 \
    libxcb-util1 \
    libxcb-cursor0 \
    # X extensions
    libxext6 \
    libxrender1 \
    libxfixes3 \
    libxdamage1 \
    libxcomposite1 \
    libxrandr2 \
    libxi6 \
    libxtst6 \
    libxkbcommon0 \
    libxkbcommon-x11-0 \
    # OpenGL
    libgl1-mesa-glx \
    libgl1-mesa-dri \
    libegl1-mesa \
    libgbm1 \
    # GTK (some OpenCV builds link against it)
    libgtk-3-0 \
    libgdk-pixbuf2.0-0 \
    libcairo2 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    # Qt5 (some OpenCV builds link against it)
    libqt5core5a \
    libqt5gui5 \
    libqt5widgets5 \
    # GLib
    libglib2.0-0 \
    # Other common deps
    libsm6 \
    libice6 \
    libfontconfig1 \
    libfreetype6 \
    libjpeg62-turbo \
    libpng16-16 \
    libtiff6 \
    libwebp7 \
    # Video codecs
    libavcodec59 \
    libavformat59 \
    libswscale6 \
    # Cleanup
    && rm -rf /var/lib/apt/lists/* \
    && ldconfig

# Copy and install requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY main.py .

# Create cache directories
RUN mkdir -p media_cache

# Expose port
EXPOSE 8000

# Run the application
CMD ["python", "main.py"]
