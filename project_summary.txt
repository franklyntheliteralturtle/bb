## Project Summary: Super Browser

### What It Is
A Poe Canvas App system for browsing Rule34.xxx content with **automated server-side nudity censorship**. The architecture consists of:
- **Canvas App** (frontend) - HTML/CSS/JS running in Poe's iframe (NOT YET BUILT)
- **Railway Server** (backend) - FastAPI with Poe Protocol, hosting a bot called "SuperBrowser"

### Current State
The backend is fully functional. The canvas app frontend has NOT been created yet.

---

## Architecture

### Backend Components

1. **Rule34Client** - Handles all Rule34.xxx API interactions
   - Tag fetching (with XML parsing fallback since API returns XML despite json=1 param)
   - Post search with filtering
   - Multi-page fetching to fill results after filtering
   - Authentication via api_key and user_id

2. **NudeDetectorONNX** - Direct ONNX inference for nudity detection
   - Two models: 320n (fast, 6MB) and 640m (accurate, 25MB)
   - Both run in parallel for best coverage
   - Manual preprocessing (no OpenCV dependency)
   - YOLO-style output parsing with NMS

3. **NudeNetCensor** - Wrapper that combines detection + censoring
   - Always uses both models
   - Black box censoring over detected regions

4. **MediaProcessor** - Orchestrates the censoring pipeline
   - Downloads original from Rule34
   - Runs dual-model censoring
   - Caches processed images to disk
   - Only processes images (no video/GIF support currently)

### Content Filtering
Posts are filtered before being returned:
- **File type**: Only images (no videos, no GIFs)
- **Aspect ratio**: Height/width between 0.4 and 2.5 (filters comic panels)
- Multi-page fetching: Fetches up to 5 API pages (500 raw posts) to fill filtered results

---

## REST API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /health` | Health check |
| `GET /tags/popular` | Returns hardcoded popular tags list |
| `GET /tags/autocomplete?q=xxx` | Tag autocomplete from Rule34 |
| `GET /posts?tags=xxx&page=0&limit=50&sort=score` | Get filtered posts |
| `GET /posts/{post_id}` | Get single post metadata |
| `GET /media/{post_id}` | Get censored image (displays in browser) |
| `GET /media/{post_id}/status` | Check if image is already processed |

### Poe Bot Commands (minimal, semi-private)
- `/tags` - Shows hardcoded popular tags
- `/search <tag> [page]` - Search with pagination

---

## Database Schema (SQLite)

```sql
-- Post metadata cache
CREATE TABLE post_cache (
    post_id INTEGER PRIMARY KEY,
    tags TEXT,
    file_url TEXT,
    sample_url TEXT,
    preview_url TEXT,
    width INTEGER,
    height INTEGER,
    file_type TEXT,
    score INTEGER,
    source TEXT,
    cached_at TIMESTAMP
);

-- Processed (censored) media cache
CREATE TABLE processed_media (
    id TEXT PRIMARY KEY,           -- Format: "r34_{post_id}"
    post_id INTEGER,
    media_type TEXT,               -- Always "image" currently
    file_path TEXT,                -- Path to censored file
    detections TEXT,               -- JSON array of detections
    processed_at TIMESTAMP
);

-- Captions cache (for future use)
CREATE TABLE captions (
    id TEXT PRIMARY KEY,
    post_id INTEGER,
    caption TEXT,
    style TEXT,
    created_at TIMESTAMP
);
```

---

## Configuration (Environment Variables)

### Required
- `POE_ACCESS_KEY` - Poe API access key
- `RULE34_API_KEY` - Rule34 API key
- `RULE34_USER_ID` - Rule34 user ID
- `SERVER_URL` - Public URL of server (for generating media URLs)

### Optional
- `DATABASE_PATH` - SQLite path (default: `cache.db`)
- `MEDIA_CACHE_DIR` - Censored images directory (default: `media_cache`)
- `MODEL_CACHE_DIR` - ONNX models directory (default: `models`)
- `CENSOR_THRESHOLD` - Detection confidence (default: `0.4`)
- `MAX_ASPECT_RATIO` - Max height/width ratio (default: `2.5`)
- `MIN_ASPECT_RATIO` - Min height/width ratio (default: `0.4`)
- `MAX_FETCH_PAGES` - API pages to fetch per logical page (default: `5`)
- `RULE34_TAG_CACHE_TTL` - Tag cache TTL in seconds (default: `300`)

---

## Files

- `main.py` - Complete FastAPI server with Poe bot
- `requirements.txt` - Python dependencies
- `railway.toml` - Railway deployment config
- `Procfile` - Process file
- `video_gif_processing_reference.md` - Extracted video/GIF code for future re-implementation

---

## Dependencies

```
fastapi-poe==0.0.48
fastapi==0.109.2
uvicorn[standard]==0.27.1
Pillow>=10.4.0
httpx>=0.26.0
aiosqlite>=0.19.0
python-dotenv>=1.0.0
sse-starlette==1.8.2
onnxruntime>=1.18.0
numpy>=1.24.0
```

No OpenCV! Uses direct ONNX inference with Pillow for image processing.

---

## Canvas App Requirements (TO BE BUILT)

### User Flow
1. **Main Page**: User sees list of popular tags (hardcoded)
2. **Tag Selection**: User picks a tag or uses autocomplete search
3. **Browse View**: Grid of uncensored thumbnails (from Rule34's `sample_url`)
4. **Detail View**: Click thumbnail â†’ see full censored image with caption

### Technical Notes
- Thumbnails load directly from Rule34 CDN (uncensored)
- Only full images go through our censoring pipeline
- `/media/{post_id}` returns JPEG that displays inline in browser
- Infinite scroll: Increment `page` parameter in `/posts` calls
- Each page returns up to 20-50 filtered results

### Canvas Constraints
- No localStorage/sessionStorage
- No alert/confirm/prompt
- Support light/dark mode
- Mobile-responsive (16px min input font)
- Use allowed CDNs only (see Poe iframe CSP)

---

## Future Work

1. **Build Canvas App** - The frontend browsing experience
2. **Caption Generation** - Use LLM to generate captions for images
3. **Re-enable GIF Support** - Code preserved in `video_gif_processing_reference.md`
4. **More Tags** - Expand `POPULAR_TAGS` list or implement better tag discovery

---

## Key Technical Decisions

1. **No OpenCV**: Railway doesn't have X11 libraries, so we use direct ONNX inference with manual NCHW preprocessing
2. **Dual Models**: Always run both 320n and 640m for best detection coverage
3. **XML Parsing**: Rule34 API returns XML despite json=1 when authenticated
4. **Multi-page Fetching**: Since ~90%+ of posts are filtered out, we fetch multiple API pages to fill results
5. **Images Only**: Videos and GIFs disabled to avoid processing complexity and large file issues
